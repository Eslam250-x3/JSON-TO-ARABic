<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ±Ø¬Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­ØªØ±Ù - Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØªØ¹Ø¯ÙŠÙ„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            left: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #555;
            transition: color 0.3s, transform 0.3s;
        }

        .settings-btn:hover {
            color: #667eea;
            transform: rotate(45deg);
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .api-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .api-option {
            position: relative;
            cursor: pointer;
        }

        .api-option input[type="radio"] {
            display: none;
        }

        .api-card {
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .api-option input[type="radio"]:checked + .api-card {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .api-card h4 {
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .api-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-weight: 500;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
        }

        .preview-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }

        .preview-tab {
            flex: 1;
            padding: 15px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .preview-tab.active {
            background: white;
            color: #667eea;
        }

        .preview-content {
            background: white;
            border-radius: 0 0 15px 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-preview {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }
        
        .file-error-display {
            padding: 30px;
            text-align: center;
        }
        
        .file-error-display h4 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .file-error-display p {
            color: #666;
            margin-bottom: 20px;
        }

        .file-preview:last-child {
            border-bottom: none;
        }

        .question-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .editable-field {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            min-height: 40px;
            cursor: text;
            transition: all 0.3s ease;
        }
        
        .editable-field:hover, .choice-item:hover {
            border-color: #667eea;
        }

        .editable-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .field-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        .choices-list {
            margin: 10px 0;
        }

        .choice-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 5px 0;
            cursor: text;
            transition: all 0.3s ease;
        }

        .download-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .download-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
        }

        .notification-area {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 90%;
            max-width: 500px;
        }

        .error-message, .success-message {
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .error-message { background: #e74c3c; }
        .success-message { background: #2ecc71; }
        
        .show-notification {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover, .close-btn:focus {
            color: black;
        }
        
        .glossary-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .glossary-item input {
            flex: 1;
        }
        
        #customPrompt, #contextTextarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .session-buttons {
            display: flex;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            .header h1 { font-size: 2rem; }
            .api-selector { grid-template-columns: 1fr; }
            .preview-tabs { flex-direction: column; }
            .download-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 10% auto; }
        }
    </style>
</head>
<body>
    <div id="notificationArea" class="notification-area"></div>

    <div class="container">
        <div class="header">
            <button id="settingsBtn" class="settings-btn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©">âš™ï¸</button>
            <h1>ğŸŒ Ù…ØªØ±Ø¬Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­ØªØ±Ù</h1>
            <p>ØªØ±Ø¬Ù…Ø© Ù…Ù„ÙØ§Øª JSON Ø¥Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</p>
        </div>

        <div class="form-section">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©</h3>
            
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:</label>
                <div class="api-selector">
                    <div class="api-option">
                        <input type="radio" id="gemini" name="apiProvider" value="gemini" checked>
                        <label for="gemini" class="api-card">
                            <h4>ğŸ¤– Google Gemini</h4>
                            <p>Ù†Ù…ÙˆØ°Ø¬ Ø¬ÙˆØ¬Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
                        </label>
                    </div>
                    <div class="api-option">
                        <input type="radio" id="chatgpt" name="apiProvider" value="chatgpt">
                        <label for="chatgpt" class="api-card">
                            <h4>ğŸ’¬ ChatGPT</h4>
                            <p>Ù†Ù…ÙˆØ°Ø¬ OpenAI Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="geminiKeyGroup">
                <label for="geminiKey">Ù…ÙØªØ§Ø­ Gemini API:</label>
                <input type="password" id="geminiKey" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini API">
            </div>

            <div class="form-group" id="chatgptKeyGroup" style="display: none;">
                <label for="chatgptKey">Ù…ÙØªØ§Ø­ ChatGPT API:</label>
                <input type="password" id="chatgptKey" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ ChatGPT API">
            </div>
        </div>

        <div class="form-section">
            <h3>ğŸ“ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</h3>
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">ğŸ“¤</div>
                <h4>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„ÙØ§Øª JSON Ù‡Ù†Ø§</h4>
                <p>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØµÙØ­ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª</p>
                <input type="file" id="fileInput" multiple accept=".json">
            </div>
            <div class="file-list" id="fileList"></div>
        </div>

        <button class="btn" id="translateBtn" onclick="startTranslation()">
            ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø©
        </button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
        </div>

        <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div class="preview-section" id="previewSection">
            <div class="form-section">
                <h3>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
                <p style="color: #666; margin-bottom: 20px;">ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø³ØªÙ‚ÙˆÙ… Ø¨Ù‡ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ù…Ù„Ù JSON Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</p>
                <div class="preview-tabs" id="previewTabs"></div>
                <div class="preview-content" id="previewContent"></div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="download-section" id="downloadSection">
            <div class="form-section">
                <h3>ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©</h3>
                <p style="color: #666; margin-bottom: 20px;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª JSON Ù…ØªØ±Ø¬Ù…Ø© Ø¨Ù†ÙØ³ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©</p>
                <div class="download-grid" id="downloadGrid"></div>
                <button class="btn btn-success" onclick="downloadAllFiles()" style="margin-top: 20px;">
                    ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (ZIP)
                </button>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                
                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª</h3>
                    <p style="color: #666; margin-bottom: 15px;">Ø§Ø­ÙØ¸ Ø¹Ù…Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø© ÙˆØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ) ÙˆØ§Ø³ØªØ£Ù†ÙÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
                    <div class="session-buttons">
                        <button id="saveSessionBtn" class="btn btn-info" style="width: auto; flex: 1;">Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                        <button id="resumeSessionBtn" class="btn btn-success" style="width: auto; flex: 1;">Ø§Ø³ØªØ¦Ù†Ø§Ù Ø¢Ø®Ø± Ø¬Ù„Ø³Ø©</button>
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>ğŸ“ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¹Ù„Ù…ÙŠ</h3>
                    <p style="color: #666; margin-bottom: 15px;">Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù„Ù„Ø¯Ø±Ø³ Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ¬Ø¹Ù„Ù‡Ø§ Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚.</p>
                    <div class="form-group">
                        <label for="contextTextarea">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³ÙŠØ§Ù‚:</label>
                        <textarea id="contextTextarea"></textarea>
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">
                
                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>ğŸ·ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©</h3>
                    <p style="color: #666; margin-bottom: 15px;">Ø­Ø¯Ø¯ Ù„Ø§Ø­Ù‚Ø© (suffix) Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>
                     <div class="form-group">
                        <label for="renameSuffix">Ù„Ø§Ø­Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:</label>
                        <input type="text" id="renameSuffix" placeholder="Ù…Ø«Ø§Ù„: _ar">
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>ğŸ“– Ù‚ÙˆØ§Ù…ÙŠØ³ Ù…Ø®ØµØµØ© (Glossaries)</h3>
                    <p style="color: #666; margin-bottom: 15px;">Ø£Ø¶Ù Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª ÙˆØªØ±Ø¬Ù…ØªÙ‡Ø§ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØ³Ø§Ù‚.</p>
                    <div id="glossaryContainer">
                        <!-- Glossary items will be added here -->
                    </div>
                    <button id="addGlossaryTermBtn" class="btn btn-secondary" style="width: auto; padding: 8px 15px; font-size: 14px;">+ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ·Ù„Ø­</button>
                </div>
                
                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0;">
                    <h3>âœï¸ ØªØ®ØµÙŠØµ Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Custom Prompts)</h3>
                     <p style="color: #666; margin-bottom: 15px;">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ±Ø³Ù„ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ.</p>
                    <div class="form-group">
                        <label for="customPrompt">Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:</label>
                        <textarea id="customPrompt"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveSettingsBtn" class="btn">Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
    </div>


    <script>
        // Global variables
        let selectedFiles = [];
        let currentApiProvider = 'gemini';
        let translatedData = [];
        let activeTab = 0;
        
        // Advanced settings variables
        let glossary = {};
        let lessonContext = '';
        let customPrompt = `Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„ØªØ±Ø¬Ù…Ø© Ù…Ù„ÙØ§Øª JSON Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
Ø£Ù†Øª Ù…ØªØ±Ø¬Ù… Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ ÙˆÙ„Ø¯ÙŠÙƒ Ø®Ø¨Ø±Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ù„ÙØ§Øª JSON. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªØ±Ø¬Ù…Ø© Ù…Ø­ØªÙˆÙ‰ Ù…Ù„Ù JSON Ù…Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ù„Ù (structure) ÙˆØ£ÙƒÙˆØ§Ø¯ HTML.
Ø§Ù„Ø³ÙŠØ§Ù‚
Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø·Ù„Ø§Ø¨. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ø¶Ø­Ø©ØŒ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ù…Ø±ÙŠ ÙˆØ§Ù„Ø¹Ù„Ù…ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨ØŒ ÙˆØ®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù†Ø­ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©.
Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
1.  ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù JSON:
    Ø¨Ø¯Ø§ÙŠØ©Ù‹ØŒ Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨Ù†ÙŠØ© Ù…Ù„Ù JSON Ø§Ù„Ù…ÙØ¹Ø·Ù‰ Ù„ÙÙ‡Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù‡Ø±Ù…ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
    Ø³ØªØ¬Ø¯ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ±Ø¬Ù…Ø© Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ©:
    stem: ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.
    html_content (Ø¯Ø§Ø®Ù„ choices): ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØµÙˆØµ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©).
    description (Ø¯Ø§Ø®Ù„ metadata): ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆØµÙ Ø§Ù„Ø³Ø¤Ø§Ù„.
    statement: ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ø¨Ø§Ø±Ø© Ø£Ùˆ Ù…Ù‚Ø¯Ù…Ø© Ù„Ù„Ø³Ø¤Ø§Ù„.
    answer (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ).
2.  Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ±Ø¬Ù…Ø©:
    Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¯Ù‚Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ØµØ·Ù„Ø­ Ù„Ù‡ Ù…Ù‚Ø§Ø¨Ù„ Ø´Ø§Ø¦Ø¹ ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬ Ø§Ù„Ù…ØµØ±ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡.
    Ø§Ù„ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ø¨Ø³Ø§Ø·Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµÙŠØ­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„ÙÙ‡Ù… Ù„Ù„Ø·Ù„Ø§Ø¨.
    Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨Ø±Ø©: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†Ø¨Ø±Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠØŒ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ø±Ø³Ù…ÙŠØ©ØŒ Ø£Ùˆ ØªØ´Ø¬ÙŠØ¹ÙŠØ©ØŒ Ø£Ùˆ Ø§Ø³ØªÙÙ‡Ø§Ù…ÙŠØ©.
    ØªØ±Ø¬Ù…Ø© ÙƒØ§Ù…Ù„Ø©: Ù‚Ù… Ø¨ØªØ±Ø¬Ù…Ø© ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡. Ù„Ø§ ØªØªØ±Ùƒ Ø£ÙŠ Ù†Øµ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.
3.  Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£ÙƒÙˆØ§Ø¯ HTML:
    Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: ÙŠØ¬Ø¨ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ÙˆØ³ÙˆÙ… (tags) ÙˆØ£ÙƒÙˆØ§Ø¯ HTML ÙƒÙ…Ø§ Ù‡ÙŠ Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±.
    ØªØ±Ø¬Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙŠÙ† ÙˆØ³ÙˆÙ… HTML ÙÙ‚Ø·.
    Ù…Ø«Ø§Ù„:
    Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ: <p>Which of the following are <b>modern</b> medical tools?</p>
    Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <p>Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠØ¹Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ© <b>Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</b>ØŸ</p>
4.  Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨Ù†ÙŠØ© JSON:
    ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù„Ù JSON Ù…Ø·Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø¨Ù†ÙŠØªÙ‡ (structure) ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (keys).
    Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù‡Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙŠ Ù‚ÙŠÙ… (values) Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ø¨Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
    Ù„Ø§ ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù Ø£ÙŠ Ù…ÙØ§ØªÙŠØ­ Ø£Ùˆ ØªØºÙŠÙŠØ± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
Ø£Ø±ÙŠØ¯ Ù…Ù†Ùƒ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‡Ùˆ Ù…Ù„Ù JSON ÙƒØ§Ù…Ù„ ÙˆÙ…ØªØ±Ø¬Ù… ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø©.
Ù„Ø§ ØªÙ‚Ù… Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø´Ø±Ø­ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§Ø±Ø¬ Ù…Ù„Ù JSON. ÙÙ‚Ø· Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ±Ø¬Ù….
\${contextSection}
\${glossarySection}
Ø§Ù„Ø¢Ù†ØŒ ÙŠØ±Ø¬Ù‰ ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¹Ù„Ù‰ Ù…Ù„Ù JSON Ø§Ù„ØªØ§Ù„ÙŠ:
\${jsonContent}
ØªØ°ÙƒØ±: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ÙƒÙˆØ¯ JSON ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„Ù‡ Ø£Ùˆ Ø¨Ø¹Ø¯Ù‡. ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ø±Ù…Ø² '{' ÙˆØªÙ†ØªÙ‡ÙŠ Ø¨Ø§Ù„Ø±Ù…Ø² '}'.`;
        let renameSuffix = '_ar';

        // DOM Elements
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeBtn = document.querySelector('.close-btn');
        const addGlossaryTermBtn = document.getElementById('addGlossaryTermBtn');
        const glossaryContainer = document.getElementById('glossaryContainer');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const customPromptTextarea = document.getElementById('customPrompt');
        const contextTextarea = document.getElementById('contextTextarea');
        const renameSuffixInput = document.getElementById('renameSuffix');
        const saveSessionBtn = document.getElementById('saveSessionBtn');
        const resumeSessionBtn = document.getElementById('resumeSessionBtn');

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSavedSettings();
        });

        function setupEventListeners() {
            document.querySelectorAll('input[name="apiProvider"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentApiProvider = this.value;
                    toggleApiKeyFields();
                });
            });

            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
            fileUpload.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files));
            });
            fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

            settingsBtn.onclick = () => { settingsModal.style.display = 'block'; populateSettingsModal(); };
            closeBtn.onclick = () => { settingsModal.style.display = 'none'; };
            window.onclick = (event) => { if (event.target == settingsModal) { settingsModal.style.display = 'none'; } };
            addGlossaryTermBtn.onclick = () => addGlossaryRow();
            saveSettingsBtn.onclick = saveAdvancedSettings;
            
            saveSessionBtn.onclick = saveSession;
            resumeSessionBtn.onclick = resumeSession;
        }

        function toggleApiKeyFields() {
            document.getElementById('geminiKeyGroup').style.display = currentApiProvider === 'gemini' ? 'block' : 'none';
            document.getElementById('chatgptKeyGroup').style.display = currentApiProvider === 'chatgpt' ? 'block' : 'none';
        }

        function handleFiles(files) {
            files.forEach(file => {
                if (!file.name.endsWith('.json')) {
                    showNotification(`Ø§Ù„Ù…Ù„Ù ${file.name} Ù„ÙŠØ³ Ù…Ù„Ù JSON.`, 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        JSON.parse(e.target.result);
                        if (!selectedFiles.find(f => f.name === file.name)) {
                            selectedFiles.push(file);
                        }
                        updateFileList();
                    } catch (err) {
                        showNotification(`Ø§Ù„Ù…Ù„Ù ${file.name} ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙŠØºØ© JSON ØºÙŠØ± ØµØ§Ù„Ø­Ø©.`, 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            if (selectedFiles.length === 0) return;

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">ğŸ“„ ${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${index})" class="btn-danger" style="padding: 5px 10px; border-radius: 4px; cursor: pointer; width: auto; margin: 0;">Ø­Ø°Ù</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function loadSavedSettings() {
            document.getElementById('geminiKey').value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('chatgptKey').value = localStorage.getItem('chatgptApiKey') || '';
            
            glossary = JSON.parse(localStorage.getItem('translationGlossary') || '{}');
            const savedPrompt = localStorage.getItem('translationCustomPrompt');
            if(savedPrompt) customPrompt = savedPrompt;
            renameSuffix = localStorage.getItem('translationRenameSuffix') || '_ar';
            lessonContext = localStorage.getItem('translationLessonContext') || '';
        }

        function saveApiKeys() {
            localStorage.setItem('geminiApiKey', document.getElementById('geminiKey').value);
            localStorage.setItem('chatgptApiKey', document.getElementById('chatgptKey').value);
        }
        
        function populateSettingsModal() {
            customPromptTextarea.value = customPrompt;
            renameSuffixInput.value = renameSuffix;
            contextTextarea.value = lessonContext;
            
            glossaryContainer.innerHTML = '';
            for (const term in glossary) {
                addGlossaryRow(term, glossary[term]);
            }
             if (Object.keys(glossary).length === 0) {
                addGlossaryRow();
            }
        }

        function addGlossaryRow(term = '', translation = '') {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'glossary-item';
            itemDiv.innerHTML = `
                <input type="text" class="glossary-term form-group" placeholder="Ø§Ù„Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø£ØµÙ„ÙŠ" value="${term}">
                <input type="text" class="glossary-translation form-group" placeholder="Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©" value="${translation}">
                <button class="btn-danger" style="padding: 5px 10px; border-radius: 50%; width: auto; margin:0;" onclick="this.parentElement.remove()">Ã—</button>
            `;
            glossaryContainer.appendChild(itemDiv);
        }
        
        function saveAdvancedSettings() {
            customPrompt = customPromptTextarea.value;
            localStorage.setItem('translationCustomPrompt', customPrompt);
            renameSuffix = renameSuffixInput.value;
            localStorage.setItem('translationRenameSuffix', renameSuffix);
            lessonContext = contextTextarea.value;
            localStorage.setItem('translationLessonContext', lessonContext);

            const newGlossary = {};
            glossaryContainer.querySelectorAll('.glossary-item').forEach(item => {
                const term = item.querySelector('.glossary-term').value.trim();
                const translation = item.querySelector('.glossary-translation').value.trim();
                if (term && translation) newGlossary[term] = translation;
            });
            glossary = newGlossary;
            localStorage.setItem('translationGlossary', JSON.stringify(glossary));
            
            showNotification('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            settingsModal.style.display = 'none';
        }
        
        function saveSession() {
            if (translatedData.length === 0) {
                showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ±Ø¬Ù…ØªÙ‡Ø§ Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©.', 'error');
                return;
            }
            const sessionData = { translatedData, activeTab };
            localStorage.setItem('translationSession', JSON.stringify(sessionData));
            showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            settingsModal.style.display = 'none';
        }

        function resumeSession() {
            const savedSession = localStorage.getItem('translationSession');
            if (!savedSession) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù„Ø³Ø© Ù…Ø­ÙÙˆØ¸Ø©.', 'error');
                return;
            }
            const sessionData = JSON.parse(savedSession);
            translatedData = sessionData.translatedData;
            activeTab = sessionData.activeTab || 0;
            
            if (translatedData && translatedData.length > 0) {
                showPreview();
                showNotification('ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø¢Ø®Ø± Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            } else {
                showNotification('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØªØ§Ù„ÙØ©.', 'error');
            }
            settingsModal.style.display = 'none';
        }

        async function startTranslation() {
            if (selectedFiles.length === 0) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª JSON Ù„Ù„ØªØ±Ø¬Ù…Ø©', 'error');
                return;
            }
            const apiKey = currentApiProvider === 'gemini' ? document.getElementById('geminiKey').value : document.getElementById('chatgptKey').value;
            if (!apiKey) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API', 'error');
                return;
            }
            saveApiKeys();

            const translateBtn = document.getElementById('translateBtn');
            const progressContainer = document.getElementById('progressContainer');
            translateBtn.disabled = true;
            translateBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...';
            progressContainer.style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';

            try {
                translatedData = new Array(selectedFiles.length);
                const promises = selectedFiles.map((file, index) => processFile(file, apiKey, index));
                await Promise.all(promises);
                
                showNotification('Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ±Ø¬Ù…Ø©!', 'success');
                showPreview();
            } catch (error) {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø©: ' + error.message, 'error');
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø©';
                progressContainer.style.display = 'none';
            }
        }
        
        async function processFile(file, apiKey, index) {
            updateProgress((index / selectedFiles.length) * 100, `Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù: ${file.name}`);
            const content = await readFileContent(file);
            const jsonData = JSON.parse(content);
            const translatedJson = await translateJsonData(jsonData, apiKey);
            translatedData[index] = { filename: file.name, original: jsonData, translated: translatedJson };
            updateProgress(((index + 1) / selectedFiles.length) * 100, `Ø§ÙƒØªÙ…Ù„Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù: ${file.name}`);
        }
        
        async function retryFileTranslation(index) {
            const apiKey = currentApiProvider === 'gemini' ? document.getElementById('geminiKey').value : document.getElementById('chatgptKey').value;
            if (!apiKey) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'error');
                return;
            }
            const fileData = translatedData[index];
            showNotification(`Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ±Ø¬Ù…Ø© Ù…Ù„Ù: ${fileData.filename}`, 'success');
            const translatedJson = await translateJsonData(fileData.original, apiKey);
            translatedData[index].translated = translatedJson;
            showTab(index);
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function translateJsonData(jsonData, apiKey) {
            const finalPrompt = getFinalPrompt(jsonData);
            let responseText = ''; // To store the response for error reporting
            try {
                responseText = await callTranslationAPI(finalPrompt, apiKey);
                const startIndex = responseText.indexOf('{');
                const endIndex = responseText.lastIndexOf('}');
                
                if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
                     throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† JSON ØµØ§Ù„Ø­ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù€ API.");
                }
        
                const jsonString = responseText.substring(startIndex, endIndex + 1);
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('Translation or JSON parsing error:', error);
                
                let userFriendlyMessage = error.message;
                const lowerResponse = responseText.toLowerCase();
                if (lowerResponse.includes('api key') || lowerResponse.includes('authenticate')) {
                    userFriendlyMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø­Ø³Ø§Ø¨Ùƒ.";
                } else if (lowerResponse.includes('billing')) {
                    userFriendlyMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ÙÙˆØ§ØªÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙÙˆØªØ±Ø© ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ø¯Ù‰ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©.";
                }

                return { error: true, message: `${userFriendlyMessage} Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: "${responseText.substring(0, 100)}..."`, originalData: jsonData };
            }
        }
        
        function getFinalPrompt(jsonData) {
            let finalPrompt = customPromptTextarea.value;

            const contextValue = contextTextarea.value.trim();
            const contextSection = contextValue 
                ? `Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù„Ù„Ø¯Ø±Ø³:\n${contextValue}`
                : '';
            finalPrompt = finalPrompt.replace(/\${contextSection}/g, contextSection);

            const glossaryEntries = Object.entries(glossary);
            const glossarySection = glossaryEntries.length > 0
                ? `Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª (Glossary) - Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©:\n${glossaryEntries.map(([term, trans]) => `- ${term}: ${trans}`).join('\n')}`
                : '';
            finalPrompt = finalPrompt.replace(/\${glossarySection}/g, glossarySection);

            const jsonContent = JSON.stringify(jsonData, null, 2);
            finalPrompt = finalPrompt.replace(/\${jsonContent}/g, jsonContent);
            
            return finalPrompt;
        }

        async function callTranslationAPI(prompt, apiKey) {
            if (currentApiProvider === 'gemini') {
                return await translateWithGemini(prompt, apiKey);
            } else {
                return await translateWithChatGPT(prompt, apiKey);
            }
        }
        
        async function translateWithGemini(prompt, apiKey) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }
            const data = await response.json();
            const translatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!translatedText) throw new Error("No content returned from Gemini API.");
            return translatedText.trim();
        }

        async function translateWithChatGPT(prompt, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo-1106',
                    response_format: { "type": "json_object" },
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 4000,
                    temperature: 0.2
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`ChatGPT: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }
            const data = await response.json();
            const translatedText = data.choices?.[0]?.message?.content;
             if (!translatedText) throw new Error("No content returned from ChatGPT API.");
            return translatedText.trim();
        }

        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewTabs = document.getElementById('previewTabs');
            const downloadSection = document.getElementById('downloadSection');
            
            previewSection.style.display = 'block';
            downloadSection.style.display = 'block';

            previewTabs.innerHTML = '';
            translatedData.forEach((item, index) => {
                const tab = document.createElement('button');
                tab.className = 'preview-tab' + (index === activeTab ? ' active' : '');
                tab.textContent = item.filename;
                tab.onclick = () => showTab(index);
                previewTabs.appendChild(tab);
            });

            showTab(activeTab);
            setupDownloadButtons();
        }

        function showTab(index) {
            activeTab = index;
            const previewContent = document.getElementById('previewContent');
            
            document.querySelectorAll('.preview-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            const fileData = translatedData[index];
            if (!fileData) return;
            
            if (fileData.translated.error) {
                previewContent.innerHTML = `
                <div class="file-error-display">
                    <h4>âš ï¸ ÙØ´Ù„Øª ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ù„Ù</h4>
                    <p>Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. Ø§Ù„Ø³Ø¨Ø¨: ${fileData.translated.message}</p>
                    <button class="btn btn-warning" style="width: auto;" onclick="retryFileTranslation(${index})">Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ù„Ù</button>
                </div>`;
                return;
            }

            let contentHtml = `<div class="file-preview">`;
            if (fileData.translated.statement) {
                contentHtml += `
                    <div class="question-item">
                        <label class="field-label">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Statement):</label>
                        <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'statement', this.innerText)">${fileData.translated.statement}</div>
                    </div>`;
            }

            if (fileData.translated.parts && Array.isArray(fileData.translated.parts)) {
                fileData.translated.parts.forEach((part, partIndex) => {
                    contentHtml += `<div class="question-item">`;
                    if (part.stem) {
                        contentHtml += `
                            <label class="field-label">Ø¬Ø°Ø¹ Ø§Ù„Ø³Ø¤Ø§Ù„ (Stem) - Ø§Ù„Ø¬Ø²Ø¡ ${partIndex + 1}:</label>
                            <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.stem', this.innerText)">${part.stem}</div>`;
                    }
                    if (part.choices) {
                        contentHtml += `<label class="field-label">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Choices):</label><div class="choices-list">`;
                        part.choices.forEach((choice, choiceIndex) => {
                            contentHtml += `<div class="choice-item" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.choices.${choiceIndex}.html_content', this.innerText)">${choice.html_content || ''}</div>`;
                        });
                        contentHtml += `</div>`;
                    }
                    if (part.answer) {
                        contentHtml += `
                            <label class="field-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Answer):</label>
                            <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.answer', this.innerText)">${part.answer}</div>`;
                    }
                    contentHtml += `</div>`;
                });
            }
             if (fileData.translated.metadata && fileData.translated.metadata.description) {
                 contentHtml += `
                    <div class="question-item">
                        <label class="field-label">Ø§Ù„ÙˆØµÙ (Description):</label>
                        <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'metadata.description', this.innerText)">${fileData.translated.metadata.description}</div>
                    </div>`;
            }
            contentHtml += `</div>`;
            previewContent.innerHTML = contentHtml;
        }
        
        function updateTranslatedData(fileIndex, path, value) {
            let obj = translatedData[fileIndex].translated;
            const keys = path.split('.');
            const lastKey = keys.pop();
            let current = obj;
            for(const key of keys) {
                if (!current[key]) current[key] = {};
                current = current[key];
            }
            current[lastKey] = value;
        }
        
        function setupDownloadButtons() {
            const downloadGrid = document.getElementById('downloadGrid');
            downloadGrid.innerHTML = '';
            translatedData.forEach((item, index) => {
                const downloadItem = document.createElement('div');
                downloadItem.className = 'download-item';
                const canDownload = item && !item.translated.error;
                downloadItem.innerHTML = `<h4>${item.filename}</h4><button class="btn btn-secondary" ${!canDownload ? 'disabled' : ''} onclick="downloadFile(${index})">ØªØ­Ù…ÙŠÙ„</button>`;
                downloadGrid.appendChild(downloadItem);
            });
        }

        function downloadFile(index) {
            const fileData = translatedData[index];
            if (fileData.translated.error) {
                showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©.', 'error');
                return;
            }
            const content = JSON.stringify(fileData.translated, null, 4);
            const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const originalName = fileData.filename.replace(/\.json$/i, '');
            const suffix = renameSuffixInput.value || '_ar';
            a.download = `${originalName}${suffix}.json`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadAllFiles() {
            const validFiles = translatedData.filter(item => item && !item.translated.error);
            if (validFiles.length === 0) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·.', 'error');
                return;
            }

            showNotification('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù Ø§Ù„Ù€ ZIP...', 'success');
            const zip = new JSZip();

            validFiles.forEach(item => {
                const content = JSON.stringify(item.translated, null, 4);
                const originalName = item.filename.replace(/\.json$/i, '');
                const suffix = renameSuffixInput.value || '_ar';
                const fileName = `${originalName}${suffix}.json`;
                zip.file(fileName, content);
            });

            try {
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "translated_files.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showNotification('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù€ ZIP.', 'error');
                console.error(e);
            }
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = text;
        }

        function showNotification(message, type = 'success') {
            const area = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = type === 'error' ? 'error-message' : 'success-message';
            notification.textContent = message;
            area.appendChild(notification);
            setTimeout(() => notification.classList.add('show-notification'), 10);
            setTimeout(() => {
                notification.classList.remove('show-notification');
                setTimeout(() => area.removeChild(notification), 300);
            }, 5000);
        }
    </script>
</body>
</html>
