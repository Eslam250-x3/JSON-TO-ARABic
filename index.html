<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุชุฑุฌู ุงูุฃุณุฆูุฉ ุงููุญุชุฑู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .dragover {
            border-color: #4f46e5;
            background-color: #e0e7ff;
        }
        .preview-card h4 {
            border-bottom: 2px solid #6366f1;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        [contenteditable]:focus {
            outline: 2px solid #818cf8;
            background-color: #f0f9ff;
            border-radius: 4px;
        }
        /* Custom styles for radio buttons */
        .api-selector input[type="radio"]:checked + label {
            border-color: #4f46e5;
            background-color: #eef2ff;
            color: #4338ca;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">๐ ูุชุฑุฌู ุงูุฃุณุฆูุฉ ุงููุญุชุฑู</h1>
            <p class="text-gray-600 mt-2 text-lg">ุชุฑุฌูุฉ ูููุงุช JSONุ ูุน ุฅููุงููุฉ ุงููุนุงููุฉ ูุงูุชุนุฏูู ูุจู ุงูุชุตุฏูุฑ</p>
        </header>

        <!-- Step 1: Settings and Upload -->
        <div id="setupSection" class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h3 class="text-2xl font-bold mb-4 text-indigo-700 border-b-2 border-indigo-200 pb-2">ุงูุฎุทูุฉ 1: ุงูุฅุนุฏุงุฏุงุช ูุฑูุน ุงููููุงุช</h3>
            
            <div class="mb-6">
                <label class="block mb-2 font-semibold text-gray-700">ุงุฎุชุฑ ููุฒููุฏ ุงูุฎุฏูุฉ:</label>
                <div class="api-selector grid grid-cols-2 gap-4">
                    <div>
                        <input type="radio" id="geminiProvider" name="apiProvider" value="gemini" class="hidden" checked>
                        <label for="geminiProvider" class="block text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition">
                            <span class="font-bold">๐ค Google Gemini</span>
                        </label>
                    </div>
                    <div>
                        <input type="radio" id="chatgptProvider" name="apiProvider" value="chatgpt" class="hidden">
                        <label for="chatgptProvider" class="block text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition">
                             <span class="font-bold">๐ฌ OpenAI ChatGPT</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="geminiKeyGroup" class="mb-6">
                <label for="geminiKey" class="block mb-2 font-semibold text-gray-700">ููุชุงุญ Gemini API:</label>
                <input type="password" id="geminiKey" placeholder="ุฃุฏุฎู ููุชุงุญ Gemini API ููุง" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            </div>
            
            <div id="chatgptKeyGroup" class="mb-6 hidden">
                <label for="chatgptKey" class="block mb-2 font-semibold text-gray-700">ููุชุงุญ OpenAI API:</label>
                <input type="password" id="chatgptKey" placeholder="ุฃุฏุฎู ููุชุงุญ OpenAI (ChatGPT) API ููุง" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-semibold text-gray-700">ูููุงุช ุงูุฃุณุฆูุฉ (JSON):</label>
                <div id="fileUpload" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-indigo-50 transition">
                    <div class="text-indigo-500 text-4xl mb-2">๐ค</div>
                    <p class="font-semibold text-gray-700">ุงุณุญุจ ูุฃููุช ุงููููุงุช ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                    <p class="text-sm text-gray-500 mt-1">ูุฌุจ ุฃู ุชููู ุงููููุงุช ุจุตูุบุฉ JSON</p>
                    <input type="file" id="fileInput" multiple accept=".json" class="hidden">
                </div>
            </div>

            <div id="fileList" class="space-y-2"></div>
            
            <button id="translateBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                ุชุฑุฌูุฉ ุงููููุงุช
            </button>
        </div>

        <!-- Step 2: Progress -->
        <div id="progressContainer" class="hidden bg-white p-6 rounded-2xl shadow-lg mb-6 text-center">
             <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-600 mx-auto"></div>
             <p id="progressText" class="mt-4 text-lg font-semibold text-gray-700">ุฌุงุฑู ุงูุชุฑุฌูุฉ...</p>
        </div>


        <!-- Step 3: Preview and Edit -->
        <div id="previewSection" class="hidden">
             <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                <h3 class="text-2xl font-bold mb-4 text-green-700 border-b-2 border-green-200 pb-2">ุงูุฎุทูุฉ 2: ูุนุงููุฉ ูุชุนุฏูู ุงูุชุฑุฌูุฉ</h3>
                <p class="text-gray-600 mb-6">ุชูุช ุชุฑุฌูุฉ ุงููุตูุต. ููููู ุงูุขู ูุฑุงุฌุนุชูุง ูุชุนุฏูู ุฃู ูุต ูุจุงุดุฑุฉ ุจุงูุถุบุท ุนููู. ุงูุชุนุฏููุงุช ุชูุญูุธ ุชููุงุฆูุงู.</p>
                <div id="previewContainer" class="space-y-6">
                    <!-- Preview cards will be inserted here -->
                </div>
             </div>
             <button id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105">
                ุชุตุฏูุฑ ุงููููุงุช ุงููุชุฑุฌูุฉ (JSON)
            </button>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const translateBtn = document.getElementById('translateBtn');
        const geminiKeyInput = document.getElementById('geminiKey');
        const chatgptKeyInput = document.getElementById('chatgptKey');
        const geminiKeyGroup = document.getElementById('geminiKeyGroup');
        const chatgptKeyGroup = document.getElementById('chatgptKeyGroup');
        const apiProviderRadios = document.querySelectorAll('input[name="apiProvider"]');
        
        const setupSection = document.getElementById('setupSection');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const previewSection = document.getElementById('previewSection');
        const previewContainer = document.getElementById('previewContainer');
        const generateBtn = document.getElementById('generateBtn');

        // --- State Variables ---
        let selectedFiles = [];
        let originalJsonData = [];
        let translatedJsonData = [];

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            geminiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            chatgptKeyInput.value = localStorage.getItem('chatgptApiKey') || '';
        });

        apiProviderRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'gemini') {
                    geminiKeyGroup.classList.remove('hidden');
                    chatgptKeyGroup.classList.add('hidden');
                } else {
                    geminiKeyGroup.classList.add('hidden');
                    chatgptKeyGroup.classList.remove('hidden');
                }
            });
        });

        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); fileUpload.classList.add('dragover'); });
        fileUpload.addEventListener('dragleave', () => fileUpload.classList.remove('dragover'));
        fileUpload.addEventListener('drop', handleFileDrop);
        fileInput.addEventListener('change', handleFileSelect);

        translateBtn.addEventListener('click', startTranslationProcess);
        generateBtn.addEventListener('click', generateFinalJsonFiles);

        // --- Functions ---

        function handleFileDrop(e) {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.json'));
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.name.endsWith('.json'));
            addFiles(files);
        }

        function addFiles(newFiles) {
            newFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });
            renderFileList();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            if (selectedFiles.length === 0) return;

            const listContainer = document.createElement('ul');
            listContainer.className = 'my-4 space-y-2';
            selectedFiles.forEach((file, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                listItem.innerHTML = `
                    <span class="font-medium text-gray-800">${file.name}</span>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                `;
                listContainer.appendChild(listItem);
            });
            fileList.appendChild(listContainer);
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        function showAlert(message, type = 'error') {
            const color = type === 'error' ? 'red' : 'green';
            const alertBox = document.createElement('div');
            alertBox.className = `fixed top-5 right-5 bg-${color}-500 text-white p-4 rounded-lg shadow-xl animate-pulse`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => alertBox.remove(), 4000);
        }

        async function startTranslationProcess() {
            const apiProvider = document.querySelector('input[name="apiProvider"]:checked').value;
            const apiKey = (apiProvider === 'gemini' ? geminiKeyInput.value : chatgptKeyInput.value).trim();

            if (!apiKey) {
                showAlert(`ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ API ูู ${apiProvider === 'gemini' ? 'Gemini' : 'ChatGPT'}.`);
                return;
            }
            if (selectedFiles.length === 0) {
                showAlert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู JSON ูุงุญุฏ ุนูู ุงูุฃูู.');
                return;
            }

            if (apiProvider === 'gemini') {
                localStorage.setItem('geminiApiKey', apiKey);
            } else {
                localStorage.setItem('chatgptApiKey', apiKey);
            }
            
            // UI transition
            setupSection.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            previewSection.classList.add('hidden');
            translateBtn.disabled = true;

            try {
                // 1. Read files
                progressText.textContent = 'ุฌุงุฑู ูุฑุงุกุฉ ุงููููุงุช...';
                originalJsonData = [];
                for (const file of selectedFiles) {
                    const content = await file.text();
                    originalJsonData.push({ name: file.name, data: JSON.parse(content) });
                }

                // 2. Translate content
                translatedJsonData = JSON.parse(JSON.stringify(originalJsonData)); // Deep copy
                let totalTasks = originalJsonData.reduce((acc, file) => acc + countTranslationTasks(file.data), 0);
                let completedTasks = 0;

                for (const file of translatedJsonData) {
                    const tasks = [];
                    if (file.data.statement) {
                        tasks.push(
                            translateText(file.data.statement, apiKey, apiProvider).then(t => {
                                file.data.statement = t;
                                completedTasks++;
                                progressText.textContent = `ุฌุงุฑู ุงูุชุฑุฌูุฉ... (${Math.round((completedTasks/totalTasks)*100)}%)`;
                            })
                        );
                    }
                    if (file.data.parts && Array.isArray(file.data.parts)) {
                        for (const part of file.data.parts) {
                            if (part.stem) {
                                tasks.push(
                                    translateText(cleanHtml(part.stem), apiKey, apiProvider).then(t => {
                                        part.stem = t;
                                        completedTasks++;
                                        progressText.textContent = `ุฌุงุฑู ุงูุชุฑุฌูุฉ... (${Math.round((completedTasks/totalTasks)*100)}%)`;
                                    })
                                );
                            }
                            if (part.answer) {
                                tasks.push(
                                    translateText(cleanHtml(part.answer), apiKey, apiProvider).then(t => {
                                        part.answer = t;
                                        completedTasks++;
                                        progressText.textContent = `ุฌุงุฑู ุงูุชุฑุฌูุฉ... (${Math.round((completedTasks/totalTasks)*100)}%)`;
                                    })
                                );
                            }
                            if(part.choices && Array.isArray(part.choices)){
                                for(let i = 0; i < part.choices.length; i++){
                                    if(part.choices[i].html_content){
                                        tasks.push(
                                            translateText(cleanHtml(part.choices[i].html_content), apiKey, apiProvider).then(t => {
                                                part.choices[i].html_content = t;
                                                completedTasks++;
                                                progressText.textContent = `ุฌุงุฑู ุงูุชุฑุฌูุฉ... (${Math.round((completedTasks/totalTasks)*100)}%)`;
                                            })
                                        );
                                    }
                                }
                            }
                        }
                    }
                    await Promise.all(tasks);
                }

                // 3. Render preview
                progressText.textContent = 'ุงูุชููุช ุงูุชุฑุฌูุฉ! ุฌุงุฑู ุนุฑุถ ุงููุชุงุฆุฌ...';
                renderPreview();
                progressContainer.classList.add('hidden');
                previewSection.classList.remove('hidden');

            } catch (error) {
                console.error('Translation process failed:', error);
                showAlert(`ุญุฏุซ ุฎุทุฃ: ${error.message}`);
                // Revert UI
                setupSection.classList.remove('hidden');
                progressContainer.classList.add('hidden');
            } finally {
                translateBtn.disabled = false;
            }
        }
        
        function countTranslationTasks(data) {
            let count = 0;
            if (data.statement) count++;
            if (data.parts && Array.isArray(data.parts)) {
                data.parts.forEach(part => {
                    if (part.stem) count++;
                    if (part.answer) count++;
                    if (part.choices && Array.isArray(part.choices)) {
                        part.choices.forEach(choice => {
                            if (choice.html_content) count++;
                        });
                    }
                });
            }
            return count;
        }

        async function translateText(text, apiKey, provider) {
            if (!text || !text.trim()) return text;
            
            if (provider === 'gemini') {
                return await translateWithGemini(text, apiKey);
            } else {
                return await translateWithChatGPT(text, apiKey);
            }
        }

        async function translateWithGemini(text, apiKey) {
            const cleanText = cleanHtml(text);
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Translate the following text to Arabic. Keep any HTML tags or LaTeX equations unchanged:\n\n${cleanText}` }] }]
                    })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Gemini API Error: ${errorBody.error?.message || response.statusText}`);
                }
                const data = await response.json();
                const translated = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return translated ? translated.trim() : text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw error;
            }
        }

        async function translateWithChatGPT(text, apiKey) {
            const cleanText = cleanHtml(text);
            const apiUrl = 'https://api.openai.com/v1/chat/completions';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o', // Using a modern model
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a professional translator. Translate the following text to Modern Standard Arabic. Keep any HTML tags or LaTeX equations unchanged.'
                            },
                            {
                                role: 'user',
                                content: cleanText
                            }
                        ],
                        temperature: 0.3
                    })
                });
                 if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`ChatGPT API Error: ${errorBody.error?.message || response.statusText}`);
                }
                const data = await response.json();
                const translated = data.choices?.[0]?.message?.content;
                return translated ? translated.trim() : text;
            } catch (error) {
                console.error("ChatGPT API call failed:", error);
                throw error;
            }
        }
        
        function cleanHtml(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        function renderPreview() {
            previewContainer.innerHTML = '';
            translatedJsonData.forEach((file, fileIndex) => {
                const card = document.createElement('div');
                card.className = 'preview-card bg-gray-50 p-4 rounded-lg border';
                
                let content = `<h3 class="text-xl font-bold text-gray-800 mb-4">๐ ${file.name}</h3>`;
                
                if (file.data.statement) {
                    content += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-indigo-700">ุงูุจูุงู (Statement)</h4>
                            <p contenteditable="true" oninput="updateData(${fileIndex}, 'statement', null, this.innerText)" class="mt-1 p-2 bg-white rounded border border-gray-200">${file.data.statement}</p>
                        </div>`;
                }

                if (file.data.parts && Array.isArray(file.data.parts)) {
                    file.data.parts.forEach((part, partIndex) => {
                        content += `<div class="border-t pt-4 mt-4">`;
                        content += `<h5 class="font-semibold text-md text-gray-700 mb-2">ุงูุฌุฒุก ${partIndex + 1}</h5>`;
                        if (part.stem) {
                             content += `
                                <div class="mb-3">
                                    <p class="font-semibold">ุงูุณุคุงู (Stem):</p>
                                    <div contenteditable="true" oninput="updateData(${fileIndex}, 'parts', ${partIndex}, this.innerText, 'stem')" class="mt-1 p-2 bg-white rounded border border-gray-200">${part.stem}</div>
                                </div>`;
                        }
                        if (part.answer) {
                             content += `
                                <div class="mb-3">
                                    <p class="font-semibold">ุงูุฅุฌุงุจุฉ (Answer):</p>
                                    <div contenteditable="true" oninput="updateData(${fileIndex}, 'parts', ${partIndex}, this.innerText, 'answer')" class="mt-1 p-2 bg-white rounded border border-gray-200">${part.answer}</div>
                                </div>`;
                        }
                        if (part.choices && Array.isArray(part.choices)) {
                            content += `<div class="mb-3"><p class="font-semibold">ุงูุฎูุงุฑุงุช (Choices):</p><ul class="list-disc pr-5 mt-2 space-y-2">`;
                            part.choices.forEach((choice, choiceIndex) => {
                                content += `<li contenteditable="true" oninput="updateData(${fileIndex}, 'parts', ${partIndex}, this.innerText, 'choice', ${choiceIndex})" class="p-1 bg-white rounded border border-gray-200">${choice.html_content}</li>`;
                            });
                            content += `</ul></div>`;
                        }
                        content += `</div>`;
                    });
                }
                card.innerHTML = content;
                previewContainer.appendChild(card);
            });
        }

        function updateData(fileIndex, key, partIndex, value, subKey = null, choiceIndex = null) {
            if (key === 'statement') {
                translatedJsonData[fileIndex].data.statement = value;
            } else if (key === 'parts') {
                const part = translatedJsonData[fileIndex].data.parts[partIndex];
                if (subKey === 'stem') part.stem = value;
                if (subKey === 'answer') part.answer = value;
                if (subKey === 'choice') part.choices[choiceIndex].html_content = value;
            }
        }

        async function generateFinalJsonFiles() {
            const zip = new JSZip();
            
            translatedJsonData.forEach(file => {
                // Reconstruct the original structure before stringifying
                const finalData = JSON.parse(JSON.stringify(originalJsonData.find(f => f.name === file.name).data));

                // Update the finalData object with the translated (and possibly edited) text
                if (finalData.statement && file.data.statement) {
                    finalData.statement = file.data.statement;
                }
                if (finalData.parts && Array.isArray(finalData.parts)) {
                    finalData.parts.forEach((part, partIndex) => {
                        const translatedPart = file.data.parts[partIndex];
                        if (part.stem && translatedPart.stem) {
                            part.stem = translatedPart.stem;
                        }
                        if (part.answer && translatedPart.answer) {
                            part.answer = translatedPart.answer;
                        }
                        if (part.choices && Array.isArray(part.choices)) {
                            part.choices.forEach((choice, choiceIndex) => {
                                if (choice.html_content && translatedPart.choices[choiceIndex]) {
                                    choice.html_content = translatedPart.choices[choiceIndex].html_content;
                                }
                            });
                        }
                    });
                }
                
                zip.file(file.name, JSON.stringify(finalData, null, 2));
            });

            try {
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = "translated_questions.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert('ุชู ุฅูุดุงุก ููู ZIP ุจูุฌุงุญ!', 'success');
            } catch (error) {
                console.error("Failed to generate zip file:", error);
                showAlert('ูุดู ุฅูุดุงุก ููู ZIP.');
            }
        }
    </script>
</body>
</html>
