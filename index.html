<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مترجم الأسئلة المحترف - مع معاينة وتعديل</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            left: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #555;
            transition: color 0.3s, transform 0.3s;
        }

        .settings-btn:hover {
            color: #667eea;
            transform: rotate(45deg);
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .api-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .api-option {
            position: relative;
            cursor: pointer;
        }

        .api-option input[type="radio"] {
            display: none;
        }

        .api-card {
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .api-option input[type="radio"]:checked + .api-card {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .api-card h4 {
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .api-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-weight: 500;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
        }

        .preview-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }

        .preview-tab {
            flex: 1;
            padding: 15px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .preview-tab.active {
            background: white;
            color: #667eea;
        }

        .preview-content {
            background: white;
            border-radius: 0 0 15px 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-preview {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }
        
        .file-error-display {
            padding: 30px;
            text-align: center;
        }
        
        .file-error-display h4 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .file-error-display p {
            color: #666;
            margin-bottom: 20px;
        }

        .file-preview:last-child {
            border-bottom: none;
        }

        .question-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .editable-field {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            min-height: 40px;
            cursor: text;
            transition: all 0.3s ease;
        }
        
        .editable-field:hover, .choice-item:hover {
            border-color: #667eea;
        }

        .editable-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .field-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        .choices-list {
            margin: 10px 0;
        }

        .choice-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 5px 0;
            cursor: text;
            transition: all 0.3s ease;
        }

        .download-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .download-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
        }

        .notification-area {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 90%;
            max-width: 500px;
        }

        .error-message, .success-message {
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .error-message { background: #e74c3c; }
        .success-message { background: #2ecc71; }
        
        .show-notification {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover, .close-btn:focus {
            color: black;
        }
        
        .glossary-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .glossary-item input {
            flex: 1;
        }
        
        #customPrompt, #contextTextarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .session-buttons {
            display: flex;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            .header h1 { font-size: 2rem; }
            .api-selector { grid-template-columns: 1fr; }
            .preview-tabs { flex-direction: column; }
            .download-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 10% auto; }
        }
    </style>
</head>
<body>
    <div id="notificationArea" class="notification-area"></div>

    <div class="container">
        <div class="header">
            <button id="settingsBtn" class="settings-btn" title="إعدادات متقدمة">⚙️</button>
            <h1>🌍 مترجم الأسئلة المحترف</h1>
            <p>ترجمة ملفات JSON إلى اللغة العربية مع معاينة وإمكانية التعديل</p>
        </div>

        <div class="form-section">
            <h3>⚙️ إعدادات الترجمة</h3>
            
            <div class="form-group">
                <label>اختر نموذج الذكاء الاصطناعي:</label>
                <div class="api-selector">
                    <div class="api-option">
                        <input type="radio" id="gemini" name="apiProvider" value="gemini" checked>
                        <label for="gemini" class="api-card">
                            <h4>🤖 Google Gemini</h4>
                            <p>نموذج جوجل المتقدم</p>
                        </label>
                    </div>
                    <div class="api-option">
                        <input type="radio" id="chatgpt" name="apiProvider" value="chatgpt">
                        <label for="chatgpt" class="api-card">
                            <h4>💬 ChatGPT</h4>
                            <p>نموذج OpenAI المتطور</p>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="geminiKeyGroup">
                <label for="geminiKey">مفتاح Gemini API:</label>
                <input type="password" id="geminiKey" placeholder="أدخل مفتاح Gemini API">
            </div>

            <div class="form-group" id="chatgptKeyGroup" style="display: none;">
                <label for="chatgptKey">مفتاح ChatGPT API:</label>
                <input type="password" id="chatgptKey" placeholder="أدخل مفتاح ChatGPT API">
            </div>
        </div>

        <div class="form-section">
            <h3>📁 رفع الملفات</h3>
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">📤</div>
                <h4>اسحب وأفلت ملفات JSON هنا</h4>
                <p>أو انقر للتصفح واختيار الملفات</p>
                <input type="file" id="fileInput" multiple accept=".json">
            </div>
            <div class="file-list" id="fileList"></div>
        </div>

        <button class="btn" id="translateBtn" onclick="startTranslation()">
            🚀 بدء الترجمة
        </button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">جاري التحضير...</div>
        </div>

        <!-- معاينة النتائج -->
        <div class="preview-section" id="previewSection">
            <div class="form-section">
                <h3>👁️ معاينة النتائج وإمكانية التعديل</h3>
                <p style="color: #666; margin-bottom: 20px;">يمكنك مراجعة الترجمات وتعديلها قبل التحميل. أي تعديل ستقوم به سيتم حفظه في ملف JSON النهائي.</p>
                <div class="preview-tabs" id="previewTabs"></div>
                <div class="preview-content" id="previewContent"></div>
            </div>
        </div>

        <!-- قسم التحميل -->
        <div class="download-section" id="downloadSection">
            <div class="form-section">
                <h3>💾 تحميل الملفات المترجمة</h3>
                <p style="color: #666; margin-bottom: 20px;">تم إنشاء ملفات JSON مترجمة بنفس عدد الملفات الأصلية</p>
                <div class="download-grid" id="downloadGrid"></div>
                <button class="btn btn-success" onclick="downloadAllFiles()" style="margin-top: 20px;">
                    📥 تحميل جميع الملفات (ZIP)
                </button>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إعدادات متقدمة</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                
                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>💾 حفظ واستئناف الجلسات</h3>
                    <p style="color: #666; margin-bottom: 15px;">احفظ عملك الحالي (الملفات المترجمة وتعديلاتك) واستأنفه لاحقًا.</p>
                    <div class="session-buttons">
                        <button id="saveSessionBtn" class="btn btn-info" style="width: auto; flex: 1;">حفظ الجلسة الحالية</button>
                        <button id="resumeSessionBtn" class="btn btn-success" style="width: auto; flex: 1;">استئناف آخر جلسة</button>
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>📝 السياق العلمي</h3>
                    <p style="color: #666; margin-bottom: 15px;">ضع هنا المحتوى العلمي للدرس لتحسين دقة الترجمة وجعلها متوافقة مع السياق.</p>
                    <div class="form-group">
                        <label for="contextTextarea">محتوى السياق:</label>
                        <textarea id="contextTextarea"></textarea>
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">
                
                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>🏷️ إعادة تسمية الملفات المترجمة</h3>
                    <p style="color: #666; margin-bottom: 15px;">حدد لاحقة (suffix) لأسماء الملفات عند التحميل.</p>
                     <div class="form-group">
                        <label for="renameSuffix">لاحقة اسم الملف:</label>
                        <input type="text" id="renameSuffix" placeholder="مثال: _ar">
                    </div>
                </div>

                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0; margin-bottom: 25px;">
                    <h3>📖 قواميس مخصصة (Glossaries)</h3>
                    <p style="color: #666; margin-bottom: 15px;">أضف المصطلحات وترجمتها المعتمدة لضمان الاتساق.</p>
                    <div id="glossaryContainer">
                        <!-- Glossary items will be added here -->
                    </div>
                    <button id="addGlossaryTermBtn" class="btn btn-secondary" style="width: auto; padding: 8px 15px; font-size: 14px;">+ إضافة مصطلح</button>
                </div>
                
                <hr style="margin: 25px 0; border: 1px solid #f1f1f1;">

                <div class="form-section" style="box-shadow: none; padding: 0;">
                    <h3>✍️ تخصيص موجه الأوامر (Custom Prompts)</h3>
                     <p style="color: #666; margin-bottom: 15px;">هذا هو الأمر الرئيسي الذي يرسل للنموذج. يمكنك تعديله ليناسب احتياجاتك.</p>
                    <div class="form-group">
                        <label for="customPrompt">موجه الأوامر:</label>
                        <textarea id="customPrompt"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveSettingsBtn" class="btn">حفظ جميع الإعدادات</button>
            </div>
        </div>
    </div>


    <script>
        // Global variables
        let selectedFiles = [];
        let currentApiProvider = 'gemini';
        let translatedData = [];
        let activeTab = 0;
        
        // Advanced settings variables
        let glossary = {};
        let lessonContext = '';
        let customPrompt = `برومبت احترافي لترجمة ملفات JSON التعليمية إلى اللغة العربية
المهمة الأساسية
أنت مترجم متخصص في المحتوى التعليمي ولديك خبرة في التعامل مع ملفات JSON. مهمتك هي ترجمة محتوى ملف JSON من اللغة الإنجليزية إلى اللغة العربية بدقة واحترافية عالية، مع الحفاظ الكامل على بنية الملف (structure) وأكواد HTML.
السياق
الملف يحتوي على أسئلة تعليمية موجهة للطلاب. يجب أن تكون الترجمة واضحة، ومناسبة للمستوى العمري والعلمي للطلاب، وخالية من الأخطاء النحوية أو الإملائية.
التعليمات التفصيلية
1.  تحليل ملف JSON:
    بدايةً، قم بتحليل بنية ملف JSON المُعطى لفهم التسلسل الهرمي للبيانات.
    ستجد النصوص التي تحتاج إلى ترجمة بشكل أساسي في الحقول التالية:
    stem: يحتوي على نص السؤال الرئيسي.
    html_content (داخل choices): يحتوي على نصوص الاختيارات (الإجابات المحتملة).
    description (داخل metadata): يحتوي على وصف السؤال.
    statement: يحتوي على أي عبارة أو مقدمة للسؤال.
    answer (إذا كان يحتوي على نص).
2.  قواعد الترجمة:
    الدقة التعليمية: حافظ على دقة المصطلحات العلمية والتعليمية. إذا كان هناك مصطلح له مقابل شائع في المناهج المصرية، استخدمه.
    الوضوح والبساطة: استخدم لغة عربية فصيحة ومباشرة وسهلة الفهم للطلاب.
    الحفاظ على النبرة: حافظ على نبرة النص الأصلي، سواء كانت رسمية، أو تشجيعية، أو استفهامية.
    ترجمة كاملة: قم بترجمة كل النصوص في الحقول المذكورة أعلاه. لا تترك أي نص باللغة الإنجليزية.
3.  التعامل مع أكواد HTML:
    مهم جداً: يجب الحفاظ على جميع وسوم (tags) وأكواد HTML كما هي دون أي تغيير.
    ترجم النص الموجود بين وسوم HTML فقط.
    مثال:
    النص الأصلي: <p>Which of the following are <b>modern</b> medical tools?</p>
    الترجمة الصحيحة: <p>أي مما يلي يعد من الأدوات الطبية <b>الحديثة</b>؟</p>
4.  الحفاظ على بنية JSON:
    يجب أن يكون الناتج النهائي ملف JSON مطابقاً للملف الأصلي في بنيته (structure) وأسماء المفاتيح (keys).
    التغيير الوحيد المسموح به هو استبدال النصوص الإنجليزية في قيم (values) الحقول المستهدفة بالترجمة العربية.
    لا تقم بإضافة أو حذف أي مفاتيح أو تغيير أنواع البيانات.
المخرجات المطلوبة:
أريد منك أن يكون الناتج النهائي هو ملف JSON كامل ومترجم وجاهز للاستخدام مباشرة.
لا تقم بتقديم شرح أو ملاحظات خارج ملف JSON. فقط الكود المترجم.
\${contextSection}
\${glossarySection}
الآن، يرجى تطبيق هذه التعليمات على ملف JSON التالي:
\${jsonContent}
تذكر: يجب أن تكون إجابتك الكاملة عبارة عن كود JSON فقط، بدون أي نص إضافي قبله أو بعده. يجب أن تبدأ الاستجابة بالرمز '{' وتنتهي بالرمز '}'.`;
        let renameSuffix = '_ar';

        // DOM Elements
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeBtn = document.querySelector('.close-btn');
        const addGlossaryTermBtn = document.getElementById('addGlossaryTermBtn');
        const glossaryContainer = document.getElementById('glossaryContainer');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const customPromptTextarea = document.getElementById('customPrompt');
        const contextTextarea = document.getElementById('contextTextarea');
        const renameSuffixInput = document.getElementById('renameSuffix');
        const saveSessionBtn = document.getElementById('saveSessionBtn');
        const resumeSessionBtn = document.getElementById('resumeSessionBtn');

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSavedSettings();
        });

        function setupEventListeners() {
            document.querySelectorAll('input[name="apiProvider"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentApiProvider = this.value;
                    toggleApiKeyFields();
                });
            });

            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
            fileUpload.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files));
            });
            fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

            settingsBtn.onclick = () => { settingsModal.style.display = 'block'; populateSettingsModal(); };
            closeBtn.onclick = () => { settingsModal.style.display = 'none'; };
            window.onclick = (event) => { if (event.target == settingsModal) { settingsModal.style.display = 'none'; } };
            addGlossaryTermBtn.onclick = () => addGlossaryRow();
            saveSettingsBtn.onclick = saveAdvancedSettings;
            
            saveSessionBtn.onclick = saveSession;
            resumeSessionBtn.onclick = resumeSession;
        }

        function toggleApiKeyFields() {
            document.getElementById('geminiKeyGroup').style.display = currentApiProvider === 'gemini' ? 'block' : 'none';
            document.getElementById('chatgptKeyGroup').style.display = currentApiProvider === 'chatgpt' ? 'block' : 'none';
        }

        function handleFiles(files) {
            files.forEach(file => {
                if (!file.name.endsWith('.json')) {
                    showNotification(`الملف ${file.name} ليس ملف JSON.`, 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        JSON.parse(e.target.result);
                        if (!selectedFiles.find(f => f.name === file.name)) {
                            selectedFiles.push(file);
                        }
                        updateFileList();
                    } catch (err) {
                        showNotification(`الملف ${file.name} يحتوي على صيغة JSON غير صالحة.`, 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            if (selectedFiles.length === 0) return;

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">📄 ${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${index})" class="btn-danger" style="padding: 5px 10px; border-radius: 4px; cursor: pointer; width: auto; margin: 0;">حذف</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function loadSavedSettings() {
            document.getElementById('geminiKey').value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('chatgptKey').value = localStorage.getItem('chatgptApiKey') || '';
            
            glossary = JSON.parse(localStorage.getItem('translationGlossary') || '{}');
            const savedPrompt = localStorage.getItem('translationCustomPrompt');
            if(savedPrompt) customPrompt = savedPrompt;
            renameSuffix = localStorage.getItem('translationRenameSuffix') || '_ar';
            lessonContext = localStorage.getItem('translationLessonContext') || '';
        }

        function saveApiKeys() {
            localStorage.setItem('geminiApiKey', document.getElementById('geminiKey').value);
            localStorage.setItem('chatgptApiKey', document.getElementById('chatgptKey').value);
        }
        
        function populateSettingsModal() {
            customPromptTextarea.value = customPrompt;
            renameSuffixInput.value = renameSuffix;
            contextTextarea.value = lessonContext;
            
            glossaryContainer.innerHTML = '';
            for (const term in glossary) {
                addGlossaryRow(term, glossary[term]);
            }
             if (Object.keys(glossary).length === 0) {
                addGlossaryRow();
            }
        }

        function addGlossaryRow(term = '', translation = '') {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'glossary-item';
            itemDiv.innerHTML = `
                <input type="text" class="glossary-term form-group" placeholder="المصطلح الأصلي" value="${term}">
                <input type="text" class="glossary-translation form-group" placeholder="الترجمة المعتمدة" value="${translation}">
                <button class="btn-danger" style="padding: 5px 10px; border-radius: 50%; width: auto; margin:0;" onclick="this.parentElement.remove()">×</button>
            `;
            glossaryContainer.appendChild(itemDiv);
        }
        
        function saveAdvancedSettings() {
            customPrompt = customPromptTextarea.value;
            localStorage.setItem('translationCustomPrompt', customPrompt);
            renameSuffix = renameSuffixInput.value;
            localStorage.setItem('translationRenameSuffix', renameSuffix);
            lessonContext = contextTextarea.value;
            localStorage.setItem('translationLessonContext', lessonContext);

            const newGlossary = {};
            glossaryContainer.querySelectorAll('.glossary-item').forEach(item => {
                const term = item.querySelector('.glossary-term').value.trim();
                const translation = item.querySelector('.glossary-translation').value.trim();
                if (term && translation) newGlossary[term] = translation;
            });
            glossary = newGlossary;
            localStorage.setItem('translationGlossary', JSON.stringify(glossary));
            
            showNotification('تم حفظ جميع الإعدادات بنجاح!', 'success');
            settingsModal.style.display = 'none';
        }
        
        function saveSession() {
            if (translatedData.length === 0) {
                showNotification('لا يوجد بيانات لترجمتها حاليًا لحفظ الجلسة.', 'error');
                return;
            }
            const sessionData = { translatedData, activeTab };
            localStorage.setItem('translationSession', JSON.stringify(sessionData));
            showNotification('تم حفظ الجلسة الحالية بنجاح.', 'success');
            settingsModal.style.display = 'none';
        }

        function resumeSession() {
            const savedSession = localStorage.getItem('translationSession');
            if (!savedSession) {
                showNotification('لم يتم العثور على جلسة محفوظة.', 'error');
                return;
            }
            const sessionData = JSON.parse(savedSession);
            translatedData = sessionData.translatedData;
            activeTab = sessionData.activeTab || 0;
            
            if (translatedData && translatedData.length > 0) {
                showPreview();
                showNotification('تم استئناف آخر جلسة بنجاح.', 'success');
            } else {
                showNotification('بيانات الجلسة المحفوظة فارغة أو تالفة.', 'error');
            }
            settingsModal.style.display = 'none';
        }

        async function startTranslation() {
            if (selectedFiles.length === 0) {
                showNotification('يرجى اختيار ملفات JSON للترجمة', 'error');
                return;
            }
            const apiKey = currentApiProvider === 'gemini' ? document.getElementById('geminiKey').value : document.getElementById('chatgptKey').value;
            if (!apiKey) {
                showNotification('يرجى إدخال مفتاح API', 'error');
                return;
            }
            saveApiKeys();

            const translateBtn = document.getElementById('translateBtn');
            const progressContainer = document.getElementById('progressContainer');
            translateBtn.disabled = true;
            translateBtn.textContent = '⏳ جاري الترجمة...';
            progressContainer.style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';

            try {
                translatedData = new Array(selectedFiles.length);
                const promises = selectedFiles.map((file, index) => processFile(file, apiKey, index));
                await Promise.all(promises);
                
                showNotification('اكتملت عملية الترجمة!', 'success');
                showPreview();
            } catch (error) {
                showNotification('حدث خطأ عام أثناء الترجمة: ' + error.message, 'error');
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = '🚀 بدء الترجمة';
                progressContainer.style.display = 'none';
            }
        }
        
        async function processFile(file, apiKey, index) {
            updateProgress((index / selectedFiles.length) * 100, `جاري معالجة ملف: ${file.name}`);
            const content = await readFileContent(file);
            const jsonData = JSON.parse(content);
            const translatedJson = await translateJsonData(jsonData, apiKey);
            translatedData[index] = { filename: file.name, original: jsonData, translated: translatedJson };
            updateProgress(((index + 1) / selectedFiles.length) * 100, `اكتملت معالجة ملف: ${file.name}`);
        }
        
        async function retryFileTranslation(index) {
            const apiKey = currentApiProvider === 'gemini' ? document.getElementById('geminiKey').value : document.getElementById('chatgptKey').value;
            if (!apiKey) {
                showNotification('يرجى إدخال مفتاح API لإعادة المحاولة', 'error');
                return;
            }
            const fileData = translatedData[index];
            showNotification(`جاري إعادة محاولة ترجمة ملف: ${fileData.filename}`, 'success');
            const translatedJson = await translateJsonData(fileData.original, apiKey);
            translatedData[index].translated = translatedJson;
            showTab(index);
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function translateJsonData(jsonData, apiKey) {
            const finalPrompt = getFinalPrompt(jsonData);
            let responseText = ''; // To store the response for error reporting
            try {
                responseText = await callTranslationAPI(finalPrompt, apiKey);
                const startIndex = responseText.indexOf('{');
                const endIndex = responseText.lastIndexOf('}');
                
                if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
                     throw new Error("لم يتم العثور على كائن JSON صالح في استجابة الـ API.");
                }
        
                const jsonString = responseText.substring(startIndex, endIndex + 1);
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('Translation or JSON parsing error:', error);
                
                let userFriendlyMessage = error.message;
                const lowerResponse = responseText.toLowerCase();
                if (lowerResponse.includes('api key') || lowerResponse.includes('authenticate')) {
                    userFriendlyMessage = "حدث خطأ متعلق بمفتاح الـ API. يرجى التحقق من صحة المفتاح أو حالة حسابك.";
                } else if (lowerResponse.includes('billing')) {
                    userFriendlyMessage = "حدث خطأ متعلق بالفواتير. يرجى التحقق من إعدادات الفوترة في حسابك لدى مزود الخدمة.";
                }

                return { error: true, message: `${userFriendlyMessage} الاستجابة الأولية من الخادم: "${responseText.substring(0, 100)}..."`, originalData: jsonData };
            }
        }
        
        function getFinalPrompt(jsonData) {
            let finalPrompt = customPromptTextarea.value;

            const contextValue = contextTextarea.value.trim();
            const contextSection = contextValue 
                ? `السياق العلمي للدرس:\n${contextValue}`
                : '';
            finalPrompt = finalPrompt.replace(/\${contextSection}/g, contextSection);

            const glossaryEntries = Object.entries(glossary);
            const glossarySection = glossaryEntries.length > 0
                ? `قائمة المصطلحات (Glossary) - استخدم هذه الترجمات المعتمدة:\n${glossaryEntries.map(([term, trans]) => `- ${term}: ${trans}`).join('\n')}`
                : '';
            finalPrompt = finalPrompt.replace(/\${glossarySection}/g, glossarySection);

            const jsonContent = JSON.stringify(jsonData, null, 2);
            finalPrompt = finalPrompt.replace(/\${jsonContent}/g, jsonContent);
            
            return finalPrompt;
        }

        async function callTranslationAPI(prompt, apiKey) {
            if (currentApiProvider === 'gemini') {
                return await translateWithGemini(prompt, apiKey);
            } else {
                return await translateWithChatGPT(prompt, apiKey);
            }
        }
        
        async function translateWithGemini(prompt, apiKey) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }
            const data = await response.json();
            const translatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!translatedText) throw new Error("No content returned from Gemini API.");
            return translatedText.trim();
        }

        async function translateWithChatGPT(prompt, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo-1106',
                    response_format: { "type": "json_object" },
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 4000,
                    temperature: 0.2
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`ChatGPT: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }
            const data = await response.json();
            const translatedText = data.choices?.[0]?.message?.content;
             if (!translatedText) throw new Error("No content returned from ChatGPT API.");
            return translatedText.trim();
        }

        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewTabs = document.getElementById('previewTabs');
            const downloadSection = document.getElementById('downloadSection');
            
            previewSection.style.display = 'block';
            downloadSection.style.display = 'block';

            previewTabs.innerHTML = '';
            translatedData.forEach((item, index) => {
                const tab = document.createElement('button');
                tab.className = 'preview-tab' + (index === activeTab ? ' active' : '');
                tab.textContent = item.filename;
                tab.onclick = () => showTab(index);
                previewTabs.appendChild(tab);
            });

            showTab(activeTab);
            setupDownloadButtons();
        }

        function showTab(index) {
            activeTab = index;
            const previewContent = document.getElementById('previewContent');
            
            document.querySelectorAll('.preview-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            const fileData = translatedData[index];
            if (!fileData) return;
            
            if (fileData.translated.error) {
                previewContent.innerHTML = `
                <div class="file-error-display">
                    <h4>⚠️ فشلت ترجمة الملف</h4>
                    <p>لم يتمكن النموذج من معالجة الملف بشكل صحيح. السبب: ${fileData.translated.message}</p>
                    <button class="btn btn-warning" style="width: auto;" onclick="retryFileTranslation(${index})">إعادة محاولة ترجمة الملف</button>
                </div>`;
                return;
            }

            let contentHtml = `<div class="file-preview">`;
            if (fileData.translated.statement) {
                contentHtml += `
                    <div class="question-item">
                        <label class="field-label">نص السؤال الرئيسي (Statement):</label>
                        <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'statement', this.innerText)">${fileData.translated.statement}</div>
                    </div>`;
            }

            if (fileData.translated.parts && Array.isArray(fileData.translated.parts)) {
                fileData.translated.parts.forEach((part, partIndex) => {
                    contentHtml += `<div class="question-item">`;
                    if (part.stem) {
                        contentHtml += `
                            <label class="field-label">جذع السؤال (Stem) - الجزء ${partIndex + 1}:</label>
                            <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.stem', this.innerText)">${part.stem}</div>`;
                    }
                    if (part.choices) {
                        contentHtml += `<label class="field-label">الخيارات (Choices):</label><div class="choices-list">`;
                        part.choices.forEach((choice, choiceIndex) => {
                            contentHtml += `<div class="choice-item" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.choices.${choiceIndex}.html_content', this.innerText)">${choice.html_content || ''}</div>`;
                        });
                        contentHtml += `</div>`;
                    }
                    if (part.answer) {
                        contentHtml += `
                            <label class="field-label">الإجابة (Answer):</label>
                            <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'parts.${partIndex}.answer', this.innerText)">${part.answer}</div>`;
                    }
                    contentHtml += `</div>`;
                });
            }
             if (fileData.translated.metadata && fileData.translated.metadata.description) {
                 contentHtml += `
                    <div class="question-item">
                        <label class="field-label">الوصف (Description):</label>
                        <div class="editable-field" contenteditable="true" oninput="updateTranslatedData(${index}, 'metadata.description', this.innerText)">${fileData.translated.metadata.description}</div>
                    </div>`;
            }
            contentHtml += `</div>`;
            previewContent.innerHTML = contentHtml;
        }
        
        function updateTranslatedData(fileIndex, path, value) {
            let obj = translatedData[fileIndex].translated;
            const keys = path.split('.');
            const lastKey = keys.pop();
            let current = obj;
            for(const key of keys) {
                if (!current[key]) current[key] = {};
                current = current[key];
            }
            current[lastKey] = value;
        }
        
        function setupDownloadButtons() {
            const downloadGrid = document.getElementById('downloadGrid');
            downloadGrid.innerHTML = '';
            translatedData.forEach((item, index) => {
                const downloadItem = document.createElement('div');
                downloadItem.className = 'download-item';
                const canDownload = item && !item.translated.error;
                downloadItem.innerHTML = `<h4>${item.filename}</h4><button class="btn btn-secondary" ${!canDownload ? 'disabled' : ''} onclick="downloadFile(${index})">تحميل</button>`;
                downloadGrid.appendChild(downloadItem);
            });
        }

        function downloadFile(index) {
            const fileData = translatedData[index];
            if (fileData.translated.error) {
                showNotification('لا يمكن تحميل الملف لأنه يحتوي على خطأ في الترجمة.', 'error');
                return;
            }
            const content = JSON.stringify(fileData.translated, null, 4);
            const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const originalName = fileData.filename.replace(/\.json$/i, '');
            const suffix = renameSuffixInput.value || '_ar';
            a.download = `${originalName}${suffix}.json`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadAllFiles() {
            const validFiles = translatedData.filter(item => item && !item.translated.error);
            if (validFiles.length === 0) {
                showNotification('لا توجد ملفات صالحة للتحميل في ملف مضغوط.', 'error');
                return;
            }

            showNotification('جاري تجهيز ملف الـ ZIP...', 'success');
            const zip = new JSZip();

            validFiles.forEach(item => {
                const content = JSON.stringify(item.translated, null, 4);
                const originalName = item.filename.replace(/\.json$/i, '');
                const suffix = renameSuffixInput.value || '_ar';
                const fileName = `${originalName}${suffix}.json`;
                zip.file(fileName, content);
            });

            try {
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "translated_files.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showNotification('فشل في إنشاء ملف الـ ZIP.', 'error');
                console.error(e);
            }
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = text;
        }

        function showNotification(message, type = 'success') {
            const area = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = type === 'error' ? 'error-message' : 'success-message';
            notification.textContent = message;
            area.appendChild(notification);
            setTimeout(() => notification.classList.add('show-notification'), 10);
            setTimeout(() => {
                notification.classList.remove('show-notification');
                setTimeout(() => area.removeChild(notification), 300);
            }, 5000);
        }
    </script>
</body>
</html>
